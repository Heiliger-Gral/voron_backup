#####################################################################
# 	Macros
#####################################################################

[gcode_macro NEVERMORE_ON]
gcode: 
	{% set FILAMENT = params.FILAMENT|default('PLA') %}
	{% if FILAMENT is in ['ABS', 'ASA'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0.85
	{% endif %}

[gcode_macro NEVERMORE_OFF]
gcode: 
	SET_FAN_SPEED FAN=Nevermore SPEED=0

#[gcode_macro PURGE_LINE]
#gcode:
#    M117 Purging...
#	G92 E0;
#	G90
#	G0 X5 Y5 F9000
#	G0 Z0.4
#	G91
#	G1 X120 E30 F1200;
#	G1 Y1
#	G1 X-120 E30 F1200;
#	G92 E0;
#    G1 Z15.0 F600 ;move the platform down 15mm
#	G92 E0 ;zero the extruded length again
#	G1 F9000
#    LED_WEISS
#    M117 Printing...

[gcode_macro FAST_QGL]
gcode:
    # Home first if needed
    G28
    QUAD_GANTRY_LEVEL  RETRY_TOLERANCE=1
    QUAD_GANTRY_LEVEL horizontal_move_z=2
    G28 Z

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    BED_MESH_CALIBRATE
    #DOCK_PROBE_UNLOCK
    ##	Uncomment for for your size printer:
    #--------------------------------------------------------------------
    ##	Uncomment for 250mm build
    #G0 X125 Y125 Z30 F3600
    
    ##	Uncomment for 300 build
    #G0 X150 Y150 Z30 F3600
    
    ##	Uncomment for 350mm build
    G0 X175 Y175 Z30 F3600
    #--------------------------------------------------------------------
 
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set TARGET_TEMP = printer.heater_bed.target %}
    M140 S0
    _BED_MESH_CALIBRATE {rawparams}
    M140 S{TARGET_TEMP}


[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
description: Quick QGL with fancy lights
gcode:
    STATUS_LEVELING                                      ; set LED things to leveling
    {% if 'x' not in printer.toolhead.homed_axes or
          'y' not in printer.toolhead.homed_axes or
          'z' not in printer.toolhead.homed_axes %}
        M118 homing X,Y,Z before quad gantry leveling...
        G28
    {% endif %}

    M118 Starting custom quick quad gantry leveling...
    _QUAD_GANTRY_LEVEL RETRY_TOLERANCE=1                 ; first pass with standard distance
    _QUAD_GANTRY_LEVEL horizontal_move_z=2               ; fine tune with 2mm distance 
    M118 QQCL complete!
    G28 Z                                                ; home z once again
    STATUS_READY                                         ; set LED things to ready
 
[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    #SETUP_VORON_PURGE
    #SETUP_KAMP_MESHING
	
    BED_MESH_CLEAR
	
    NEVERMORE_ON FILAMENT={params.FILAMENT}

    SET_LED_EFFECT EFFECT=skirt_heating     ; Set skirt LEDs to heating-mode
    STATUS_HEATING             ; Set LEDs to heating-mode
    
    M117 Heating bed
    M190 S{ params.BED }       ; Wait for bed to get to target temperature.

    M117 Preheating nozzle
    M109 S150                  ; Wait for nozzle to heat to 150C - soften filament, but no oozing.

    M107                       ; Print fan off
	SET_DISPLAY_TEXT MSG="Homing"
	STATUS_HOMING                ; Set LEDs to homing-mode
    G28                          ; home all axes
	QUAD_GANTRY_LEVEL
	G28 Z 
    STATUS_CALIBRATING_Z
	BED_MESH_CALIBRATE ADAPTIVE=1 RUNS=2 
    CLEAN_NOZZLE
    CARTOGRAPHER_TOUCH_HOME	
    G1 X150 Y347 Z5 F12000                  ; move nozzle away from bed

    STATUS_HEATING             ; Set LEDs to heating-mode
    SET_DISPLAY_TEXT MSG="Heat up nozzle to 160c"
    M117 Heating nozzle
    M109 S{ params.EXTRUDER }  ; Wait for nozzle to get to target temperature.
    CLEAN_NOZZLE

    G90                 ; Absolute coordinates.
    M83                 ; Relative extruder mode.
    G92 E0

    M400
#    SET_DISPLAY_TEXT MSG="Clean and purge at print temperature..."
#    PARK_PURGE_CLEAN_PRINT_START
    
    SET_DISPLAY_TEXT MSG="Printer goes brr"              ; Display info on display
    STATUS_PRINTING                                      ; Set LEDs to printing-mode
    M117 Printing
    _SHUTDOWN_HANDLER_START_PRINT
   

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
#    G1 E-15.0 F3600                ; retract filament
    G91                            ; relative positioning
#    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y325 F3600            ; park nozzle at rear
    TURN_OFF_HEATERS
    #M109 S50
    M107                                     ; turn off fan
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    BED_MESH_CLEAR
    NEVERMORE_OFF
    SET_DISPLAY_TEXT MSG="COMPLETE" # Displays info
    M84
    _SHUTDOWN_HANDLER_STOP_PRINT

# printer.cfg

[gcode_macro SHUTDOWN]
gcode:
  {action_call_remote_method("shutdown_machine")}

[gcode_macro REBOOT]
gcode:
  {action_call_remote_method("reboot_machine")}
    
#[gcode_macro NEVERMORE_ON]
#gcode = 
#	{% set FILAMENT = params.FILAMENT|default('PLA') %}
#	{% if FILAMENT is in ['ABS', 'ASA'] %}
#	SET_FAN_SPEED FAN=nevermore SPEED=0.85
#	{% endif %}

#[gcode_macro NEVERMORE_OFF]
#gcode = 
#	SET_FAN_SPEED FAN=nevermore SPEED=0


[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.