## Test load/unload on specified gates with optional temporary speed/accel overrides
[gcode_macro EMU_SPEED_TEST]
description: Test load/unload on specified gates with optional temporary speed/accel overrides. If a speed/accel combination causes the EMU to stall, you have to use the e-stop to terminate the iterations, else you will grind filament.
gcode:
  # Params:
  #   GATES      - comma-separated gates (default "0")
  #   ITERATIONS - cycles per gate (default 1)
  #   SPEED      - override for BOTH gear_from_spool_speed & gear_unload_speed
  #   ACCEL      - override for BOTH gear_from_spool_accel & gear_unload_accel
  {% set GATES = params.GATES|default("0")|string %}
  {% set ITERATIONS = params.ITERATIONS|default(1)|int %}
  {% set tools = GATES.split(",") %}

  # --- Snapshot current [mmu] values ---
  {% set _mmu = printer.configfile.settings.mmu %}
  {% set save_gfss = _mmu.gear_from_spool_speed|float %}
  {% set save_gfsa = _mmu.gear_from_spool_accel|float %}
  {% set save_gus  = _mmu.gear_unload_speed|float %}
  {% set save_gua  = _mmu.gear_unload_accel|float %}

  # --- Determine overrides (fallback to current if not supplied) ---
  {% set OV_SPEED = params.SPEED|default(save_gfss)|float %}
  {% set OV_ACCEL = params.ACCEL|default(save_gfsa)|float %}

  {% if (tools|length > 0) and (ITERATIONS > 0) %}
      M400
      RESPOND TYPE=echo MSG="EMU_SPEED_TEST: Starting. Gates={GATES}, Iterations={ITERATIONS}."
      RESPOND TYPE=echo MSG="EMU_SPEED_TEST: Applying overrides -> Speed={OV_SPEED}, Accel={OV_ACCEL}."
      M400

      # Apply temporary overrides
      mmu_test_config gear_from_spool_speed={OV_SPEED} gear_from_spool_accel={OV_ACCEL} gear_unload_speed={OV_SPEED} gear_unload_accel={OV_ACCEL} quiet=1

      # --- Main test loops ---
      {% for tool in tools %}
         {% set tool_trim = tool|trim %}
         {% for i in range(ITERATIONS) %}
            {% set i1 = i + 1 %}
            M400
            RESPOND TYPE=echo MSG="EMU_SPEED_TEST: Gate {tool_trim} • Iteration {i1}/{ITERATIONS} • Speed={OV_SPEED} • Accel={OV_ACCEL}."
            M400
            MMU_SELECT TOOL={tool_trim}
            _MMU_STEP_LOAD_BOWDEN
            _MMU_STEP_UNLOAD_BOWDEN
            mmu_check_gate
         {% endfor %}
         mmu_recover
         mmu_unload
         mmu_check_gate
      {% endfor %}

      # --- Restore original values ---
      M400
      RESPOND TYPE=echo MSG="EMU_SPEED_TEST: Restoring original MMU values -> Speed(from_spool)={save_gfss}, Accel(from_spool)={save_gfsa}, Speed(unload)={save_gus}, Accel(unload)={save_gua}."
      M400
      mmu_test_config gear_from_spool_speed={save_gfss} gear_from_spool_accel={save_gfsa} gear_unload_speed={save_gus} gear_unload_accel={save_gua} quiet=1

      M400
      RESPOND TYPE=echo MSG="EMU_SPEED_TEST: Done."
      M400
  {% else %}
      M400
      RESPOND TYPE=echo MSG="EMU_SPEED_TEST: Gate(s) not provided or iterations < 1."
      M400
  {% endif %}